---
title: "Analysis 2 - Simulation-estimation"
format: html
editor: visual
---

# Simulation-estimation studies to infer and account for activity levels

What is the scale of the problem and to what extent can we overcome it using our proposed model?

Demonstrate underestimation of R0 when activity level not accounted for

\- Illustration that individual variation in contact rates increases the eigenvalue. This effect is stronger with higher assortativity, but still the case with less assortativity

see Leon's analysis in ContactMatrixSplit.qmd for mostly complete code

NEED: single-panel figure: number of activity classes on bottom, lines for each assortativity level.

Demonstrate we can estimate activity levels

\- Illustration with toy example (based on Tom's) that we can estimate the variance with a random effects model, and learn the parameters

See Nick's analysis in tom_contact_demo.qmd for a full example on a simple simulation

NEED: rework tom_contact_demo.qmd to have slightly more realistic data simulation from a known model, fit the model, and estimate the true parameters

Demonstrate we can build augmented contact matrices and recover a less-biased R0

\- Using the estimated parameters, build a kroneckered multi-activity level contact matrix and recover a less-biased R0. See how this depends on the number of classes

NEED: rework tom_contact_demo.qmd to have multiple activity classes and demonstrate that it approaches true eigenvalues

(is 'true' eigenvalue just the limiting case where all individuals have their own class in the matrix?)

Load packages and functions

```{r}
#| message: false
#| warning: false
source("R/packages.R")
source("R/functions.R")
```

## Demonstrate scale of problem

Demonstrate underestimation of R0 when activity level not accounted for

Illustration that individual variation in contact rates increases the eigenvalue. This effect is stronger with higher assortativity, but still the case with less assortativity.

Run computations in parallel
```{r}
plan(multisession, workers = 8)
```

### Old plot

Apply for a range of assortativities and numbers of activity level bins

```{r}
output <- expand_grid(
  assort = seq(0, 1, 0.1),
  bins = seq(1, 10, 1)
)|> 
  mutate(
    tmp = furrr::future_map2(assort,
                             bins,
                             ~ map_to_eigen(assort = .x,
                                            number_of_quantiles = .y),
                             .options = furrr_options(seed = TRUE))
  ) |> 
  unnest(
    tmp
  )

output |> 
  select(
    assort,
    bins,
    eigenvalue = tmp
  ) |> 
  mutate(
    bins = as_factor(bins)
  )|> 
  ggplot(
    aes(
      x = assort,
      y = eigenvalue,
      colour = bins)
  ) +
  geom_line() +
  geom_point() +
  xlab("Assortativity")
```

### New plot

In the above plot, assortativity is on the x axis and therefore appears as the primary point of the plot, whereas the manuscript is more about activity levels. The colour is plotted as the number of bins, which is a metric of quality of the approximation than a measure of variation in activity levels. Therefore, try a new plot that plots eigencvalues against the activity level standard deviation sigma (x axis) with assortativity in colour.

```{r}
output <- expand_grid(
  sigma = seq(0, 1, 0.05),
  assort = seq(0, 1, 0.2)
)|> 
  mutate(
    eigenvalue = furrr::future_map2(sigma,
                                    assort,
                                    ~ map_to_eigen(sigma = .x,
                                                   assort = .y,
                                                   number_of_quantiles = 300),
                             .options = furrr_options(seed = TRUE))
  ) |> 
  unnest(
    eigenvalue
  )
```

Plot the results

```{r}
activity_assort_plot <- output |> 
  select(
    Assortativity = assort,
    sigma,
    eigenvalue
  ) |> 
  ggplot(
    aes(
      x = sigma,
      y = eigenvalue,
      group = Assortativity,
      colour = Assortativity)
  ) +
  geom_line() +
  scale_color_gradient(
    low = grey(0.8),
    high = "blue"
  ) +
  xlab("Variation in activity levels") +
  ylab("Eigenvalue") +
  theme_minimal()
activity_assort_plot
```

Save this plot for the manuscript

```{r}
ggsave("figures/activity_assort_plot.png",
       plot = activity_assort_plot,
       bg = "white",
       scale = 1,
       width = 6,
       height = 4)
```
